<!-- Alden Chia Yu Xiang
2205584
DISM/FT/2A/01 -->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="../../css/navbar.css" rel="stylesheet" />
    <link href="../../css/adminNavbar.css" rel="stylesheet" />
    <link href="../../css/adminBack.css" rel="stylesheet" />
    <link href="../../css/addGame.css" rel="stylesheet" />
    <title>Admin Panel - Add Game</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

    <style>
        .category {
            text-align: right;
        }

        .category input[type="checkbox"] {
            margin-left: 10px;
        }
    </style>
</head>

<body>
    <div class="navbar" id="navbar"></div>
    <div class="admin_navbar" id="admin_navbar"></div>
    <div class="back" id="back">
        <a href="http://localhost:3001/admin_game.html" id="back">
            <i class="fas fa-backward" id="back_icon"></i>
        </a>
    </div>

    <div class="start_container" id="start_container">
        <h2 class="add_platform_title" id="add_platform_title">Add New Game</h2>

        <form class="input_group" id="input_group" enctype="multipart/form-data">
            <div class="title">
                <label for="title">Title:</label>
                <input type="text" id="title" class="input" name="title"><br>
            </div>

            <div class="year">
                <label for="year">Year:</label>
                <input type="number" id="year" name="year" min="1900" max="2023">
            </div>

            <div class="description">
                <label for="Description">Description:</label>
                <textarea type="text" id="Description" class="input" name="Description"></textarea><br><br>
            </div>

            <div class="categorystart">
                <div class="category-label">
                    <label for="category">Categories:</label>
                </div>
                <div class="category" id="category">
                </div>
            </div>

            <div class="platform-label">
                <label for="platform">Platforms:</label>
            </div>
            <div class="platformNprice" id="platformNprice">
                <div id="platformCheckboxes">
                </div>
            </div>

            <div class="fileUpload" id="fileUpload">
                <input type="file" id="myfile" name="myfile"><br><br>
            </div>

            <div class="buttons">
                <input type="submit" id="submit" value="Submit">
                <input type="reset" id="reset" value="Reset">
            </div>
            <div id="msg"></div>
        </form>
    </div>

    <script src="../../js/navbar.js"></script>
    <script src="../../js/adminNavbar.js"></script>
    <script src="../../js/verifyAdmin.js"></script>

    <script>
        $(document).ready(() => {

            try {
                let userid = userData[0].userid
            } catch {
                location.assign('http://localhost:3001/error.html')
            }

            let selectedCategories = [];
            let selectedPlatforms = [];
            let selectedPrices = [];

            $('#submit').click(() => {
                event.preventDefault(); // Prevent the default form submission behavior
                
                // Clear the selectedCategories array
                selectedCategories = [];
                selectedPlatforms = [];
                selectedPrices = [] 

                $('.category input[type="checkbox"]:checked').each(function () {
                    var selectedCategory = $(this).val();
                    selectedCategories.push(selectedCategory);
                });

                $('.platform-checkbox input[type="checkbox"]:checked').each(function () {
                    var selectedPlatform = $(this).val();
                    selectedPlatforms.push(selectedPlatform)
                })

                $('.price-input').each(function () {
                    var priceInput = $(this).val();
                    if (priceInput !== "") {
                        selectedPrices.push(priceInput);
                    }
                });

                var localStorageToken = localStorage.getItem('token');

                if (!localStorageToken) {
                    location.assign('http://localhost:3001/error.html')
                    return
                }

                let headers = {
                    authorization: 'Bearer ' + localStorageToken
                }

                var categories = selectedCategories.join(', ');
                var platforms = selectedPlatforms.join(', ');
                var prices = selectedPrices.join(', ');

                let points = "0";
                for (let i = 1; i < selectedPlatforms.length; i++) {
                    points += ", 0";
                }

                let data = {
                    title: $('#title').val(),
                    year: $('#year').val(),
                    description: $('#Description').val(),
                    categoryid: categories,
                    platformid: platforms,
                    price: prices,
                    points: points
                }


                console.log(data)

                $.ajax({
                    headers: headers,
                    url: "http://localhost:8081/add/game",
                    type: "POST",
                    data: JSON.stringify(data),
                    contentType: "application/json",
                    dataType: "json",
                    success: (data, status, xhr) => {
                        $('#msg').text("Successfully added game without image")

                        let gameImage = $('#myfile')[0].files[0];
                        if (gameImage) {
                            // If there is an image, run the add image AJAX request
                            try {
                                let formData = new FormData();
                                formData.append('myfile', gameImage);
                                formData.append('title', $('#title').val());

                                $.ajax({
                                    url: "http://localhost:8081/add/image",
                                    type: "POST",
                                    data: formData,
                                    processData: false,
                                    contentType: false,
                                    success: (data, status, xhr) => {
                                        console.log(data);
                                        console.log("Uploading Image");
                                        $('#msg').text("Successfully added game with image");
                                    },
                                    error: (xhr, status, err) => {
                                        console.log(err);
                                    }
                                });
                            } catch {
                                console.log("Error uploading image");
                            }
                        } else {
                            // If there is no image, do nothing
                            console.log("No image uploaded");
                        }
                    },
                    error: (xhr, status, err) => {
                        console.log(err);
                        if (err == "Unprocessable Entity") {
                            $('#msg').text("Title already exists");
                        } else {
                            $('#msg').text("Failed to add game");
                        }
                    }
                });
            });

            $.ajax({
                url: 'http://localhost:8081/get/platforms',
                type: 'GET',
                dataType: 'json',
                success: (data, status, xhr) => {
                    var tempHTML = "";
                    data.forEach((platform) => {
                        tempHTML += `
                            <div class="platform-checkbox">
                                <input type="checkbox" id="${platform.platformid}" name="platform" value="${platform.platformid}">
                                <label for="${platform.platformid}">${platform.platformname}</label>
                                <input type="number" class="price-input" placeholder="Price" id="quantity${platform.platformid}" name="price" min="0.00" max="500.00" disabled>
                            </div>
                        `;
                    });
                    $('#platformCheckboxes').html(tempHTML);
                },
                error: (xhr, status, err) => {
                    console.log(err);
                }
            });

            // Enable/disable price input based on checkbox state
            $('#platformCheckboxes').on('change', '.platform-checkbox input[type="checkbox"]', function () {
                const priceInput = $(this).closest('.platform-checkbox').find('.price-input');
                priceInput.prop('disabled', !$(this).is(':checked'));
            });

            let availableCategories = 0;

            $.ajax({
                url: 'http://localhost:8081/get/categories',
                type: 'GET',
                dataType: 'json',
                success: (data, status, xhr) => {
                    var tempHTML = "";
                    data.forEach((category) => {
                        tempHTML += `<div class=category-checkbox><input type="checkbox" id="${category.categoryid}" name="${category.categoryid}" value="${category.categoryid}"><label for="${category.categoryid}"> ${category.categoryname}</label><br></div>`;
                    });
                    $('#category').html(tempHTML);
                    availableCategories = data.length; // Store the number of available categories
                },
                error: (xhr, status, err) => {
                    console.log(err);
                }
            });

            $('#reset').on('click', () => {
                // Remove additional category dropdowns
                $('.category-container').remove();

                // Remove additional platform dropdowns
                $('.platform-container').remove();
            });
        });
    </script>
</body>

</html>